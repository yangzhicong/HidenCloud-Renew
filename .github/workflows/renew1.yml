name: HidenCloud Auto Renew

on:
  # 定时触发：每 3 天运行一次（周一上午 10:00 UTC）
  schedule:
    - cron: '0 10 */3 * *'
  
  # 手动触发
  workflow_dispatch:

jobs:
  renew:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: 安装依赖
        run: npm install
      
      - name: 执行续期脚本
        env:
          # 从仓库变量读取 Cookie
          COOKIE1: ${{ vars.COOKIE1 }}
          COOKIE2: ${{ vars.COOKIE2 }}
          COOKIE3: ${{ vars.COOKIE3 }}
          COOKIE4: ${{ vars.COOKIE4 }}
          COOKIE5: ${{ vars.COOKIE5 }}
          COOKIE6: ${{ vars.COOKIE6 }}
          COOKIE7: ${{ vars.COOKIE7 }}
          COOKIE8: ${{ vars.COOKIE8 }}
          COOKIE9: ${{ vars.COOKIE9 }}
          COOKIE10: ${{ vars.COOKIE10 }}
        run: node local_renew.js
      
      - name: 更新仓库变量
        if: always()  # 即使续期失败也尝试更新 Cookie
        env:
          GITHUB_TOKEN: ${{ secrets.ACTION_VARS_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: node update_vars.js
      
      - name: 上传缓存文件（用于调试）
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cookie-cache
          path: hiden_cookies_cache.json
          retention-days: 7
